# name: Restrict Releases to Specific Branch

# on:
#   release:
#     types: [created]

# jobs:
#   check_release_branch:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Get Release Information
#         run: echo "Release created from commit ${{ github.event.release.target_commitish }}"

#       - name: Check if release is from the allowed branch
#         run: |
#           ALLOWED_BRANCH="release"
#           RELEASE_BRANCH=${{ github.event.release.target_commitish }}

#           if [ "$RELEASE_BRANCH" != "$ALLOWED_BRANCH" ]; then
#             echo "❌ Releases are only allowed from the '$ALLOWED_BRANCH' branch."
#             exit 1
#           fi


name: Restrict Releases to "release" Branch

on:
  release:
    types: [created]

jobs:
  check_release_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Get Release Information
        run: echo "Release created from branch: ${{ github.event.release.target_commitish }}"

      - name: Check if release is from the 'release' branch
        run: |
          ALLOWED_BRANCH="release"
          RELEASE_BRANCH="${{ github.event.release.target_commitish }}"

          if [ "$RELEASE_BRANCH" != "$ALLOWED_BRANCH" ]; then
            echo "❌ Releases are only allowed from the '$ALLOWED_BRANCH' branch."
            exit 1
          fi

  delete_unauthorized_release:
    needs: check_release_branch
    if: failure()  # "release" 以外のブランチなら削除処理を実行
    runs-on: ubuntu-latest
    steps:
      - name: Get Release ID
        id: get_release_id
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}  # GITHUB_TOKEN ではなく、PAT を使用
        run: |
          RELEASE_ID=$(gh release view ${{ github.event.release.tag_name }} --json id --jq '.id')
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV

      - name: Delete Unauthorized Release
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh release delete ${{ github.event.release.tag_name }} --yes
          echo "🚨 Unauthorized release deleted."
