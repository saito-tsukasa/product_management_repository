name: Prevent Branch Creation from release and source_code_god
on:
  create:
    branches:
      - '*'
jobs:
  check-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # すべての履歴を取得

      - name: Check if branch was created from restricted branches
        run: |
          NEW_BRANCH="${GITHUB_REF#refs/heads/}"
          
          # ブロック対象のブランチリスト
          BLOCKED_BRANCHES=("release" "source_code_god")

          # 新規ブランチの元ブランチを推測
          for BLOCKED in "${BLOCKED_BRANCHES[@]}"; do
            BASE_BRANCH=$(git merge-base $NEW_BRANCH origin/$BLOCKED || echo "none")

            if [ "$BASE_BRANCH" == "$(git rev-parse origin/$BLOCKED)" ]; then
              echo "ERROR: New branches cannot be created from '$BLOCKED'."
              exit 1
            fi
          done
          
          echo "✅ This branch creation is allowed."
