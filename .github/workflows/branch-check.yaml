# name: Prevent Branch Creation from "release" and "source_code_god"
# on:
#   create:
#     branches:
#       - '*'
# jobs:
#   check-source:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0  # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—

#       - name: Check if branch was created from restricted branches
#         run: |
#           NEW_BRANCH="${GITHUB_REF#refs/heads/}"

#           # ãƒ–ãƒ­ãƒƒã‚¯å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒãƒªã‚¹ãƒˆ
#           BLOCKED_BRANCHES=("release" "source_code_god")

#           # å„ãƒ–ãƒ­ãƒƒã‚¯å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã€æ–°è¦ãƒ–ãƒ©ãƒ³ãƒã®å…±é€šã®ç¥–å…ˆã‚’å–å¾—
#           for BLOCKED in "${BLOCKED_BRANCHES[@]}"; do
#             COMMON_ANCESTOR=$(git merge-base $NEW_BRANCH origin/$BLOCKED || echo "")

#             # å…±é€šã®ç¥–å…ˆãŒãƒ–ãƒ­ãƒƒã‚¯å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
#             BLOCKED_COMMIT=$(git rev-parse origin/$BLOCKED 2>/dev/null || echo "")

#             if [ "$COMMON_ANCESTOR" == "$BLOCKED_COMMIT" ]; then
#               echo "âŒ New branches cannot be created from '$BLOCKED'."
#               exit 1
#             fi
#           done

#           echo "âœ… This branch creation is allowed."




# name: Restrict Branch Creation

# on:
#   create:
#     branches:
#       - '**'  # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’ç›£è¦–

# jobs:
#   check-branch-creation:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check if branch is created from restricted branches
#         run: |
#           BASE_BRANCH=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/${{ github.ref_name }}" \
#             | jq -r '.object.sha')

#           if [ "${{ github.ref }}" == "refs/heads/release" ] || [ "${{ github.ref }}" == "refs/heads/source_code_god" ]; then
#             echo "âŒ æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ 'release' ã¾ãŸã¯ 'source_code_god' ã‹ã‚‰ä½œæˆã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚"
#             exit 1
#           fi

#           echo "${{ github.ref }}  ${{ github.ref_name }}"




name: Restrict Branch Creation

on:
  create:
    branches:
      - '**'  # ã™ã¹ã¦ã®æ–°è¦ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’ç›£è¦–

jobs:
  check-branch-creation:
    runs-on: ubuntu-latest
    steps:
      - name: Get Source Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO=${{ github.repository }}
          NEW_BRANCH=${{ github.ref_name }}

          echo "ğŸ“Œ æ–°è¦ãƒ–ãƒ©ãƒ³ãƒ: $NEW_BRANCH"

          # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã® SHA ã‚’å–å¾—
          LATEST_COMMIT_SHA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/git/refs/heads/$NEW_BRANCH" | jq -r '.object.sha')

          echo "ğŸ” æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ SHA: $LATEST_COMMIT_SHA"

          # è¦ªã‚³ãƒŸãƒƒãƒˆã® SHA ã‚’å–å¾—
          PARENT_COMMIT_SHA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/commits/$LATEST_COMMIT_SHA" | jq -r '.parents[0].sha')

          echo "ğŸ“ è¦ªã‚³ãƒŸãƒƒãƒˆ SHA: $PARENT_COMMIT_SHA"

          # è¦ªã‚³ãƒŸãƒƒãƒˆãŒå±ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒï¼ˆä½œæˆå…ƒãƒ–ãƒ©ãƒ³ãƒï¼‰ã‚’å–å¾—
          SOURCE_BRANCH=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/branches" | jq -r --arg PARENT "$PARENT_COMMIT_SHA" \
            '.[] | select(.commit.sha == $PARENT) | .name')

          if [ -z "$SOURCE_BRANCH" ]; then
            echo "âš ï¸ ä½œæˆå…ƒãƒ–ãƒ©ãƒ³ãƒãŒç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
            exit 1
          fi

          echo "âœ… ä½œæˆå…ƒãƒ–ãƒ©ãƒ³ãƒ: $SOURCE_BRANCH"

          # åˆ¶é™ã—ãŸã„ãƒ–ãƒ©ãƒ³ãƒã®ãƒªã‚¹ãƒˆ
          BLOCKED_BRANCHES=("release" "source_code_god")

          for BLOCKED in "${BLOCKED_BRANCHES[@]}"; do
            if [ "$SOURCE_BRANCH" == "$BLOCKED" ]; then
              echo "ğŸš« ã‚¨ãƒ©ãƒ¼: '$SOURCE_BRANCH' ã‹ã‚‰æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚"
              exit 1
            fi
          done

          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒä½œæˆã¯è¨±å¯ã•ã‚Œã¾ã—ãŸã€‚"





# name: ãƒ–ãƒ©ãƒ³ãƒä½œæˆåˆ¶é™

# on:
#   create:
#     branches:
#       - '**' # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼

# jobs:
#   check-branch-creation:
#     runs-on: ubuntu-latest
#     steps:
#       - name: ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
#         id: get-branch-name
#         run: echo "::set-output name=branch_name::$(echo $GITHUB_REF | cut -d '/' -f 3)"

#       - name: ç¦æ­¢ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ä½œæˆã‚’ãƒã‚§ãƒƒã‚¯
#         if: contains(fromJson('["release", "source_code_god"]'), steps.get-branch-name.outputs.branch_name)
#         uses: actions/github-script@v6
#         with:
#           script: |
#             core.setFailed('ã“ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒä½œæˆã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚');

#       - name: developãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ä½œæˆã‚’è¨±å¯
#         if: steps.get-branch-name.outputs.branch_name == 'develop'
#         uses: actions/github-script@v6
#         with:
#           script: |
#             console.log('developãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ä½œæˆã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚');
